name: PDF Merge


on:
  workflow_dispatch:
    inputs:
      job_id:
        description: "PDF job id"
        required: true
      folder_id:
        description: "Drive folder id with PDF chunks"
        required: true
      clean_chunks:
        description: "Delete chunk PDFs after merge"
        required: false
        default: "false"

jobs:
  merge:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CALLBACK_URL: ${{ secrets.BACKEND_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate callback URL
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "Missing CALLBACK_URL (set BACKEND_URL)"
            exit 1
          fi
          case "$CALLBACK_URL" in
            https://script.google.com/macros/s/*/exec) echo "Using Apps Script callback URL" ;;
            *) echo "Warning: CALLBACK_URL is not an Apps Script URL (${CALLBACK_URL})" ;;
          esac

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/merge_pdf_from_drive.requirements.txt

      - name: Write credentials
        run: |
          echo "${{ secrets.GDRIVE_CREDENTIALS_JSON }}" | base64 -d > credentials.json
          TOKEN_HTTP_CODE=$(curl -sS -L -G -o /tmp/merge_token_response.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-token" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            "${CALLBACK_URL}")
          echo "merge-token HTTP ${TOKEN_HTTP_CODE}"
          if [ "${TOKEN_HTTP_CODE}" -ge 200 ] && [ "${TOKEN_HTTP_CODE}" -lt 300 ]; then
            set +e
            python -c "import json,sys; p=json.load(open('/tmp/merge_token_response.json','r',encoding='utf-8')); d=(p.get('data') or {}); raw=d.get('token_json'); \
if (not p.get('ok')) or (not raw): raise SystemExit(1); t=json.loads(raw); \
if not t.get('refresh_token'): raise SystemExit(1); json.dump(t, open('token.json','w',encoding='utf-8'))"
            TOKEN_PARSE_STATUS=$?
            set -e
            if [ "${TOKEN_PARSE_STATUS}" -eq 0 ]; then
              echo "Using merge token from backend Script Properties."
            else
              echo "Backend merge token invalid, falling back to GitHub secret GDRIVE_TOKEN_JSON."
              echo "${{ secrets.GDRIVE_TOKEN_JSON }}" | base64 -d > token.json
            fi
          else
            echo "Backend merge token unavailable, falling back to GitHub secret GDRIVE_TOKEN_JSON."
            echo "${{ secrets.GDRIVE_TOKEN_JSON }}" | base64 -d > token.json
          fi
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_status_1.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-status" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${{ inputs.job_id }}" \
            --data-urlencode "run_id=${{ github.run_id }}" \
            --data-urlencode "progress=20" \
            --data-urlencode "message=Downloading chunks" \
            "${CALLBACK_URL}")
          echo "merge-status(Downloading chunks) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_1.json || true
            exit 1
          fi

      - name: Merge PDFs
        id: merge
        run: |
          set -e
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_status_2.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-status" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${{ inputs.job_id }}" \
            --data-urlencode "run_id=${{ github.run_id }}" \
            --data-urlencode "progress=60" \
            --data-urlencode "message=Merging PDFs" \
            "${CALLBACK_URL}")
          echo "merge-status(Merging PDFs) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_2.json || true
            exit 1
          fi
          CLEAN_FLAG=""
          if [ "${{ inputs.clean_chunks }}" = "true" ]; then
            CLEAN_FLAG="--clean-chunks"
          fi
          timeout 45m python -u scripts/merge_pdf_from_drive.py --folder-id "${{ inputs.folder_id }}" --credentials credentials.json --token token.json --no-browser $CLEAN_FLAG \
            1> /tmp/merge_out.txt 2> /tmp/merge_err.txt
          echo "---- merge stdout (tail) ----"
          tail -n 50 /tmp/merge_out.txt || true
          echo "---- merge stderr (tail) ----"
          tail -n 50 /tmp/merge_err.txt || true
          RESULT=$(cat /tmp/merge_out.txt | tail -n 1)
          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Notify backend
        run: |
          JOB_ID="${{ inputs.job_id }}"
          RESULT='${{ steps.merge.outputs.result }}'
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_status_3.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-status" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${JOB_ID}" \
            --data-urlencode "run_id=${{ github.run_id }}" \
            --data-urlencode "progress=85" \
            --data-urlencode "message=Uploading merged PDF" \
            "${CALLBACK_URL}")
          echo "merge-status(Uploading merged PDF) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_3.json || true
            exit 1
          fi
          FILE_ID=$(python -c "import json,os; d=json.loads(os.environ['RESULT']); print(d['file_id'])")
          URL=$(python -c "import json,os; d=json.loads(os.environ['RESULT']); print(d['url'])")
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_status_4.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-status" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${JOB_ID}" \
            --data-urlencode "run_id=${{ github.run_id }}" \
            --data-urlencode "progress=92" \
            --data-urlencode "message=Finalizing" \
            "${CALLBACK_URL}")
          echo "merge-status(Finalizing) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_4.json || true
            exit 1
          fi
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_complete.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-complete" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${JOB_ID}" \
            --data-urlencode "file_id=${FILE_ID}" \
            --data-urlencode "url=${URL}" \
            --data-urlencode "clean_chunks=${{ inputs.clean_chunks }}" \
            "${CALLBACK_URL}")
          echo "merge-complete HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_complete.json || true
            exit 1
          fi
        env:
          RESULT: ${{ steps.merge.outputs.result }}

      - name: Notify backend (merge failed)
        if: ${{ failure() }}
        run: |
          ERROR_MSG="$(tail -c 1500 /tmp/merge_err.txt 2>/dev/null || echo 'GitHub Action failed')"
          STATUS_CODE=$(curl -sS -L -G -o /tmp/merge_failed.json -w "%{http_code}" \
            --data-urlencode "path=pdf/merge-failed" \
            --data-urlencode "token=${{ secrets.PDF_MERGE_TOKEN }}" \
            --data-urlencode "job_id=${{ inputs.job_id }}" \
            --data-urlencode "message=${ERROR_MSG}" \
            "${CALLBACK_URL}")
          echo "merge-failed HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_failed.json || true
            exit 1
          fi
