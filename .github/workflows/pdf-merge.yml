name: PDF Merge


on:
  workflow_dispatch:
    inputs:
      job_id:
        description: "PDF job id"
        required: true
      folder_id:
        description: "Drive folder id with PDF chunks"
        required: true

jobs:
  merge:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CALLBACK_URL: ${{ secrets.BACKEND_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate callback URL
        run: |
          if [ -z "$CALLBACK_URL" ]; then
            echo "Missing CALLBACK_URL (set BACKEND_URL)"
            exit 1
          fi
          case "$CALLBACK_URL" in
            https://script.google.com/macros/s/*/exec) echo "Using Apps Script callback URL" ;;
            *) echo "Warning: CALLBACK_URL is not an Apps Script URL (${CALLBACK_URL})" ;;
          esac

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/merge_pdf_from_drive.requirements.txt

      - name: Write credentials
        run: |
          echo "${{ secrets.GDRIVE_CREDENTIALS_JSON }}" | base64 -d > credentials.json
          echo "${{ secrets.GDRIVE_TOKEN_JSON }}" | base64 -d > token.json
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_status_1.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-status" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${{ inputs.job_id }}\",\"progress\":20,\"message\":\"Downloading chunks\"}")
          echo "merge-status(Downloading chunks) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_1.json || true
            exit 1
          fi

      - name: Merge PDFs
        id: merge
        run: |
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_status_2.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-status" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${{ inputs.job_id }}\",\"progress\":60,\"message\":\"Merging PDFs\"}")
          echo "merge-status(Merging PDFs) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_2.json || true
            exit 1
          fi
          RESULT=$(python scripts/merge_pdf_from_drive.py --folder-id "${{ inputs.folder_id }}" --credentials credentials.json --token token.json --no-browser)
          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Notify backend
        run: |
          JOB_ID="${{ inputs.job_id }}"
          RESULT='${{ steps.merge.outputs.result }}'
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_status_3.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-status" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${JOB_ID}\",\"progress\":85,\"message\":\"Uploading merged PDF\"}")
          echo "merge-status(Uploading merged PDF) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_3.json || true
            exit 1
          fi
          FILE_ID=$(python - <<'PY'
          import json, os, sys
          data=json.loads(os.environ['RESULT'])
          print(data['file_id'])
          PY
          )
          URL=$(python - <<'PY'
          import json, os, sys
          data=json.loads(os.environ['RESULT'])
          print(data['url'])
          PY
          )
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_status_4.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-status" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${JOB_ID}\",\"progress\":92,\"message\":\"Finalizing\"}")
          echo "merge-status(Finalizing) HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_status_4.json || true
            exit 1
          fi
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_complete.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-complete" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${JOB_ID}\",\"file_id\":\"${FILE_ID}\",\"url\":\"${URL}\"}")
          echo "merge-complete HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_complete.json || true
            exit 1
          fi
        env:
          RESULT: ${{ steps.merge.outputs.result }}

      - name: Notify backend (merge failed)
        if: ${{ failure() }}
        run: |
          STATUS_CODE=$(curl -sS -L -o /tmp/merge_failed.json -w "%{http_code}" -X POST "${CALLBACK_URL}?path=pdf/merge-failed" \
            -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PDF_MERGE_TOKEN }}\",\"job_id\":\"${{ inputs.job_id }}\",\"message\":\"GitHub Action failed\"}")
          echo "merge-failed HTTP ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 400 ]; then
            cat /tmp/merge_failed.json || true
            exit 1
          fi
