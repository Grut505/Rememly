# PDF Merge Setup (A to Z)

This guide covers the full PDF merge setup with the current architecture:

- chunks are generated by Apps Script
- merge runs in GitHub Actions
- Drive OAuth token is stored in Apps Script (`GDRIVE_TOKEN_JSON`)
- token refresh is automatic before each merge trigger
- GitHub `GDRIVE_TOKEN_JSON` secret is optional fallback

---

## 1) Prerequisites

- Access to the repository
- Access to GitHub repository settings (Secrets)
- Access to Apps Script project (Project Settings / Script Properties)
- Access to Google Cloud Console for OAuth credentials

---

## 2) Create or rotate Drive OAuth credentials

1. Open Google Cloud Console credentials page for your project.
2. Create an **OAuth Client ID**.
3. App type: **Desktop app**.
4. Download JSON and save it as `scripts/credentials.json`.
5. Ensure Drive API is enabled in the same Google Cloud project.

If Google shows "app not verified", add your account in OAuth test users.

---

## 3) Generate `token.json` locally

Preferred command:

```bash
./scripts/regen_drive_token.sh
```

Options:

```bash
./scripts/regen_drive_token.sh --no-browser
./scripts/regen_drive_token.sh --print-base64
```

What it does:

- installs dependencies in `scripts/.venv` if needed
- runs OAuth authorization
- recreates `scripts/token.json`
- optionally prints base64 for GitHub secrets

---

## 4) Set Apps Script properties (required)

In **Apps Script > Project Settings > Script properties**, set:

- `GITHUB_TOKEN` (PAT with repo access, used to dispatch workflow)
- `PDF_MERGE_TOKEN` (shared secret with GitHub workflow callbacks)
- `GDRIVE_TOKEN_JSON` (**raw JSON content** of `scripts/token.json`, not base64)

Optional:

- `GITHUB_REPO` (default: `Grut505/Rememly`)
- `GITHUB_PDF_MERGE_WORKFLOW` (default: `pdf-merge.yml`)
- `GITHUB_PDF_MERGE_REF` (default: `main`)

Important:

- `GDRIVE_TOKEN_JSON` must contain at least: `refresh_token`, `client_id`, `client_secret`, `token_uri`, `scopes`

---

## 5) Set GitHub secrets

In **GitHub > Settings > Secrets and variables > Actions**, set:

- `BACKEND_URL` (Apps Script web app URL)
- `PDF_MERGE_TOKEN` (must match Apps Script property)
- `GDRIVE_CREDENTIALS_JSON` (base64 of `scripts/credentials.json`)
- `GDRIVE_TOKEN_JSON` (base64 of `scripts/token.json`) optional fallback but recommended

To generate base64 values:

```bash
./scripts/encode_github_secrets.sh
```

---

## 6) Deploy backend and install triggers

1. Deploy Apps Script backend.
2. Run `installPdfWorker()` once from Apps Script editor.

`installPdfWorker()` now installs:

- `pdfWorkerTick` every minute
- `pdfMergeTokenMaintenanceTick` daily (06:00)

The daily tick refreshes the merge token proactively.

---

## 7) How automatic refresh works

When Apps Script triggers merge workflow:

1. `triggerPdfMergeWorkflow(...)` first refreshes Drive token using `refresh_token`.
2. If refresh fails, workflow is not triggered and job gets explicit error message.
3. If refresh succeeds, workflow dispatch continues.

When GitHub workflow starts:

1. It tries `GET path=pdf/merge-token` on backend.
2. If backend token is valid, it uses that token.
3. If backend token is unavailable/invalid, it falls back to GitHub `GDRIVE_TOKEN_JSON` secret.

---

## 8) Settings page controls

In app Settings > Maintenance:

- `Refresh merge token` button calls `pdf/merge-token-refresh`
- UI shows whether token is configured and current expiry

Use this as manual fallback if needed.

---

## 9) Local merge script (optional)

For local/manual merge from a folder:

```bash
cd scripts
python merge_pdf_from_drive.py --folder-id <FOLDER_ID> --credentials credentials.json --token token.json
```

Auth-only mode:

```bash
python merge_pdf_from_drive.py --credentials credentials.json --token token.json --auth-only
```

---

## 10) Full validation checklist

- [ ] `scripts/credentials.json` exists and is current
- [ ] `scripts/token.json` regenerated
- [ ] Apps Script property `GDRIVE_TOKEN_JSON` set with raw JSON
- [ ] Apps Script property `PDF_MERGE_TOKEN` matches GitHub secret
- [ ] GitHub secrets updated (`BACKEND_URL`, `PDF_MERGE_TOKEN`, `GDRIVE_CREDENTIALS_JSON`, `GDRIVE_TOKEN_JSON`)
- [ ] `installPdfWorker()` executed once after deploy
- [ ] Settings page shows token configured
- [ ] Test PDF generation with auto-merge succeeds

---

## 11) Troubleshooting

### Error: `GDRIVE_TOKEN_JSON is not configured`

- Add `GDRIVE_TOKEN_JSON` in Apps Script properties with raw JSON from `scripts/token.json`.

### Error: `No valid token.json found in CI`

- Regenerate `scripts/token.json` locally.
- Update Apps Script `GDRIVE_TOKEN_JSON`.
- Optionally update GitHub fallback secret `GDRIVE_TOKEN_JSON` (base64).

### Error: refresh fails with invalid_grant

- Refresh token is revoked/expired/invalid.
- Re-run OAuth (`./scripts/regen_drive_token.sh`) and update properties/secrets.

### Merge trigger failed (422 / GitHub)

- Check `GITHUB_TOKEN`, `GITHUB_REPO`, workflow name/ref in Apps Script properties.

---

## 12) Security and rotation

If tokens/secrets were exposed:

1. Rotate OAuth client secret in Google Cloud.
2. Regenerate `scripts/credentials.json`.
3. Regenerate `scripts/token.json`.
4. Update Apps Script `GDRIVE_TOKEN_JSON`.
5. Update GitHub secrets.
6. Re-run a merge test.
